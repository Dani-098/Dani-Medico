<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Practice Tests - Dani Medico</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* --- 1. ORIGINAL CSS PRESERVED EXACTLY --- */
        :root {
            --color-primary-blue: #007BFF;
            --color-primary-blue-light: #4da6ff;
            --color-primary-blue-dark: #0056b3;
            --color-secondary-green: #28A745;
            --color-secondary-green-light: #34ce57;
            --color-secondary-green-dark: #1e7e34;
            --color-light: #F8F9FA;
            --color-dark: #343A40;
            --color-text: #495057;
            --color-card-bg: #FFFFFF;
            --color-shadow: rgba(0, 0, 0, 0.1);
            --color-danger: #DC3545;
            --color-danger-light: #e4606d;
            --color-warning: #FFC107;
            --color-warning-light: #ffce3a;
            --font-family-primary: 'Poppins', sans-serif;
            --border-radius-base: 12px;
            --transition-speed: 0.4s;
            --animation-duration: 0.5s;
        }

        html, body { 
            width: 100%; 
            margin: 0; 
            padding: 0; 
            overflow-x: hidden; 
            position: relative; 
            box-sizing: border-box; 
            font-family: var(--font-family-primary); 
            line-height: 1.6;
            color: var(--color-text); 
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            min-height: 100vh;
            display: flex; 
            flex-direction: column;
            padding-top: 55px;
        }
        *, *:before, *:after { box-sizing: inherit; }
        * { margin: 0; padding: 0; }

        .container { 
            width: 100%; 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 15px 20px; 
            flex-grow: 1; 
        }
        section { padding: 2rem 0; }
        a { text-decoration: none; color: var(--color-primary-blue); transition: all var(--transition-speed); }
        a:hover { color: var(--color-secondary-green); }
        h1, h2, h3, h4 { color: var(--color-dark); margin-bottom: 1rem; position: relative; }
        h2 { display: inline-block; padding-bottom: 0.5rem; position: relative; margin-bottom: 1.5rem; color: var(--color-dark); }
        h2::after {
            content: ''; 
            position: absolute; 
            left: 0; 
            bottom: 0; 
            width: 60px; 
            height: 4px;
            background: linear-gradient(90deg, var(--color-primary-blue), var(--color-secondary-green));
            border-radius: 2px;
        }

        #navbar { 
            background: linear-gradient(135deg, var(--color-primary-blue) 0%, var(--color-primary-blue-dark) 100%);
            color: var(--color-light); 
            padding: 0.75rem 1.5rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.2);
            z-index: 1000; 
            position: fixed; 
            top: 0; 
            left: 0;
            right: 0;
            width: 100%;
        }
        .logo { font-size: 1.4rem; font-weight: 700; color: var(--color-light); display: flex; align-items: center; gap: 0.75rem; transition: transform var(--transition-speed); }
        .logo-img { height: 70px; width: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        .nav-links { display: flex; align-items: center; }
        .nav-links a { 
            color: var(--color-light); 
            margin-left: 0.75rem; 
            padding: 0.5rem 0.75rem; 
            font-weight: 500; 
            transition: all var(--transition-speed); 
            border-radius: 8px; 
            position: relative;
            overflow: hidden;
            font-size: 0.9rem; 
            display: flex;
            align-items: center;
            gap: 0.4rem; 
            white-space: nowrap;
        }
        .nav-links a.active { background: rgba(255, 255, 255, 0.1); }

        .card-grid { 
            display: grid; 
            gap: 20px; 
            margin-top: 1.5rem; 
            width: 100%; 
        }
        @media (min-width: 1024px) { .card-grid { grid-template-columns: repeat(5, 1fr); } }
        @media (max-width: 1023px) { .card-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 480px) { .card-grid { grid-template-columns: 1fr; } }

        .card { 
            background: linear-gradient(145deg, var(--color-card-bg) 0%, #f8f9fa 100%);
            padding: 1.5rem; 
            border-radius: var(--border-radius-base); 
            box-shadow: 0 6px 20px var(--color-shadow); 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
            justify-content: space-between; 
            border-left: 5px solid var(--color-secondary-green);
            transition: all var(--transition-speed);
            position: relative;
            overflow: hidden;
        }
        .card:hover { transform: translateY(-8px) scale(1.02); }

        /* Meta style for cards */
        .card-meta { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; font-size: 0.75rem; color: #666; font-weight: 500; }
        .card-meta span { display: flex; align-items: center; gap: 3px; }

        .filters-section { 
            background: linear-gradient(145deg, var(--color-card-bg) 0%, #f8f9fa 100%);
            padding: 1.5rem; 
            border-radius: var(--border-radius-base); 
            box-shadow: 0 6px 20px var(--color-shadow); 
            display: grid; 
            grid-template-columns: repeat(4, 1fr);
            gap: 20px; 
            margin-bottom: 2rem; 
            border-left: 4px solid var(--color-primary-blue);
        }
        .filter-group label { font-weight: 600; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 8px; font-size: 0.95rem; color: var(--color-dark); }
        .filter-group select, .filter-group input { width: 100%; padding: 0.85rem; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; background: var(--color-card-bg); }

        .button, .primary-button { display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; text-align: center; border: none; font-size: 0.85rem; width: 100%; transition: 0.4s; }
        .primary-button { background: linear-gradient(135deg, var(--color-secondary-green) 0%, var(--color-secondary-green-dark) 100%); color: white; }
        .secondary-button { background: white; color: var(--color-primary-blue); border: 2px solid var(--color-primary-blue); }

        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px); overflow-y: auto; }
        .modal-content { background: white; margin: 20px auto; padding: 30px; border-radius: 16px; width: 95%; max-width: 1200px; position: relative; min-height: 90vh; }
        .close-btn { position: absolute; top: 15px; right: 25px; color: #333; font-size: 35px; font-weight: bold; cursor: pointer; z-index: 100; }
        .close-btn:hover { color: var(--color-danger); }

        /* Logic Styles */
        .mcq-step { display: none; }
        .mcq-step.active { display: block; animation: fadeIn 0.4s ease; }
        .quiz-footer { display: flex; justify-content: space-between; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #eee; }
        .correct-ans { background: #d4edda !important; border-color: #28a745 !important; color: #155724; }
        .wrong-ans { background: #f8d7da !important; border-color: #dc3545 !important; color: #721c24; }
        .hidden { display: none !important; }
        #timer-display { font-weight: bold; color: white; background: var(--color-danger); padding: 10px 20px; border-radius: 30px; display: inline-flex; align-items: center; gap: 0.75rem; margin-bottom: 15px; }

        footer { background: linear-gradient(135deg, var(--color-primary-blue-dark) 0%, var(--color-primary-blue) 100%); color: var(--color-light); padding: 2rem 1rem 0; margin-top: 3rem; }
        .footer-top { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1.5rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); gap: 1rem; }
        .logo-img-footer { height: 80px; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    
<header>
    <nav id="navbar">
        <div class="logo">
            <img src="assets/images/logo.png" alt="Dani Medico Logo" class="logo-img">
            Dani Medico
        </div>
        <div class="nav-links" id="navLinks">
            <a href="/"><i class="fas fa-home"></i> Home</a>
            <a href="/dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="/lectures"><i class="fas fa-video"></i> Books</a>
            <a href="/notes"><i class="fas fa-book-open"></i> Notes</a>
            <a href="/tests" class="active"><i class="fas fa-pencil-alt"></i> Tests</a>
            <a href="/past-papers"><i class="fas fa-file-alt"></i> Papers</a>
            <a href="/announcement"><i class="fas fa-bullhorn"></i> News</a>
        </div>
        <button class="mobile-menu-btn" onclick="mobileMenuToggle()"><i class="fas fa-bars"></i></button>
    </nav>
</header>

<main class="container">
    <h2><i class="fas fa-pencil-alt"></i> Practice Tests</h2>
    <section class="filters-section card">
        <div class="filter-group">
            <label><i class="fas fa-map-marker-alt"></i> Province:</label>
            <select id="filter-province" onchange="updateExams()">
                <option value="all">All Provinces</option>
                <option value="Sindh">Sindh</option>
                <option value="Punjab">Punjab</option>
                <option value="KPK">KPK</option>
                <option value="Balochistan">Balochistan</option>
                <option value="Islamabad">Islamabad</option>
            </select>
        </div>
        <div class="filter-group">
            <label><i class="fas fa-clipboard-list"></i> Exam:</label>
            <select id="filter-exam" onchange="updateSubjects()">
                <option value="all">All Exams</option>
            </select>
        </div>
        <div class="filter-group">
            <label><i class="fas fa-book"></i> Subject:</label>
            <select id="filter-subject" onchange="updateChapters()">
                <option value="all">All Subjects</option>
            </select>
        </div>
        <div class="filter-group">
            <label><i class="fas fa-layer-group"></i> Chapter:</label>
            <select id="filter-chapter" onchange="loadTests()">
                <option value="all">All Chapters</option>
            </select>
        </div>
    </section>

    <div id="tests-container" class="card-grid"></div>
</main>

<div id="configModal" class="modal">
    <div class="modal-content" style="max-width: 500px; min-height: auto;">
        <span class="close-btn" onclick="closeModal('configModal')">&times;</span>
        <h3 class="text-center">Student Registration</h3>
        <form id="details-form" onsubmit="handleDetailsSubmit(event)">
            <div class="filter-group"><label>Name:</label><input type="text" id="user-name" required placeholder="Full Name"></div>
            <div class="filter-group"><label>City:</label><input type="text" id="user-city" required placeholder="City"></div>
            <div class="filter-group"><label>WhatsApp No:</label><input type="tel" id="user-whatsapp" required placeholder="03XXXXXXXXX"></div>
            <button type="submit" class="button primary-button">Start Test</button>
        </form>
    </div>
</div>

<div id="testModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('testModal')">&times;</span>
        <h3 id="test-modal-title">Quiz</h3>
        <div id="timer-container" class="text-center">
            <div id="timer-display"><i class="fas fa-clock"></i> Time Left: <span id="time-left">00:00</span></div>
        </div>
        <form id="mcq-form">
            <div id="mcq-steps-container"></div>
        </form>
    </div>
</div>

<div id="resultPopup" class="modal">
    <div class="modal-content" style="max-width: 500px; text-align: center; min-height: auto;">
        <span class="close-btn" onclick="closeModal('resultPopup')">&times;</span>
        <i class="fas fa-award fa-4x" style="color: #FFC107;"></i>
        <h2>Test Completed!</h2>
        <div id="final-score" style="font-size: 3.5rem; font-weight: 700; color: #28A745; margin: 15px 0;">0%</div>
        <p>Correct: <span id="final-correct">0</span> / <span id="final-total">0</span></p>
        <div style="display: grid; gap: 12px; margin-top: 25px;">
            <button class="secondary-button" onclick="checkTest(); closeModal('resultPopup');"><i class="fas fa-search"></i> Check Test</button>
            <button class="primary-button" onclick="downloadTestPDF()" style="background:#DC3545;"><i class="fas fa-file-pdf"></i> Download Result PDF</button>
            <button class="button" onclick="closeModal('resultPopup')" style="background:#eee;">Close</button>
        </div>
    </div>
</div>

<footer>
    <div class="footer-top container">
        <div class="footer-links">
            <a href="/about">About Us</a> <a href="/contact">Contact</a>
        </div>
        <img src="assets/images/logo.png" alt="Logo" class="logo-img-footer">
    </div>
</footer>

<script>
    const mdcatExams = ["MDCAT", "BSN", "NUMS", "AKU", "AFNS"];
    const examSubjects = { 
        "all": ["All Subjects"], 
        "MDCAT": ["Biology", "Chemistry", "Physics", "English", "Logical Reasoning"],
        "BSN": ["Biology", "Chemistry", "Physics", "English", "Logical Reasoning"],
        "NUMS": ["Biology", "Chemistry", "Physics", "English", "Logical Reasoning"],
        "AKU": ["Biology", "Chemistry", "Physics", "English", "Logical Reasoning"],
        "AFNS": ["Biology", "Chemistry", "Physics", "English", "Logical Reasoning"]
    };
    
    const examSubjectChapters = { 
        "MDCAT_Biology": ["1. ACELLULAR LIFE", "2. BIOENERGETICS", "3. BIOLOGICAL MOLECULES", "4. CELL STRUCTURE & FUNCTION", "5. COORDINATION & CONTROL", "6. ENZYMES", "7. EVOLUTION", "8. REPRODUCTION", "9. SUPPORT & MOVEMENT", "10. INHERITENCE", "11. CIRCULATION", "12. IMMUNITY", "13. RESPIRATION", "14. DIGESTION", "15. HOMEOSTASIS", "16. BIOTECHNOLOGY"],
        "MDCAT_Chemistry": ["1. INTRO TO FUNDAMENTAL CONCEPTS OF CHEMISTRY", "2. ATOMIC STRUCTURE", "3. GASES", "4. LIQUIDS", "5. SOLIDS", "6. CHEMICAL EQUILIBRIUM", "7. REACTION KINETICS", "8. THERMO-CHEMISTRY & ENERGETICS OF CHEMICAL REACTIONS", "9. ELECTROCHEMISTRY", "10. CHEMICAL BONDING", "11.S & P Block Elements", "12.TRANSITION ELEMENTS", "13.FUNDAMENTAL PRINCIPLES OF ORGANIC CHEMISTRY", "14.CHEMISTRY OF HYDROCARBONS", "15.ALKYL HALIDES", "16.ALCOHOLS & PHENOLS", "17.ALDEHYDES & KETONES", "18. CARBOXYLIC ACIDS", "19. MACROMOLECULES"],
        "MDCAT_Physics": ["1.VECTORS & EQUILIBRIUM", "2.FORCE & MOTION", "3.WORK & ENERGY", "4.ROTATIONAL & CIRCULAR MOTION", "5.FLUID DYNAMICS", "6.WAVES", "7.THERMODYNAMICS", "8.ELECTROSTATICS", "9.CURRENT ELECTRICITY", "10.ELECTROMAGNETISM", "11.ELECTROMAGNETIC INDUCTION", "12.ALTERNATING CURRENT", "13.ELECTRONICS", "14.DAWN OF MODERN PHYSICS", "15.ATOMIC SPECTRA", "16.NUCLEAR PHYSICS"]
    };

    /* --- 2. FULL ORIGINAL MCQ DATA PRESERVED (Sampled for brevity but keep yours) --- */
    const testsData = [{"id": "T1","title": "BIOLOGY SINDH MDCAT","subject": "Biology","chapter": "1. ACELLULAR LIFE","exam": "MDCAT","province": "Sindh","mcqs":[{"q": "Viruses are classified as acellular because they:","options": ["Have cells but are small","Lack cellular structure","Are multicellular","Have organelles"],"answer": 1},{"q": "Viruses are considered:","options": ["Living organisms","Non-living outside host","Both living and non-living","Always living"],"answer": 1},{"q": "The genetic material of viruses can be:","options": ["DNA only","RNA only","DNA or RNA","Proteins"],"answer": 2},{"q": "Viruses that infect bacteria are called:","options": ["Bacteriophages","Retroviruses","Mycoviruses","Arboviruses"],"answer": 0},{"q": "HIV is a:","options": ["DNA virus","RNA retrovirus","Bacteriophage","Plant virus"],"answer": 1},{"q": "The protein coat of a virus is called:","options": ["Capsid","Envelope","Nucleocapsid","Membrane"],"answer": 0},{"q": "Viruses that have an outer lipid membrane are called:","options": ["Naked viruses","Enveloped viruses","Capsid viruses","Simple viruses"],"answer": 1},{"q": "TMV (Tobacco Mosaic Virus) is a:","options": ["DNA virus","RNA virus","Retrovirus","Bacteriophage"],"answer": 1},{"q": "Which virus causes AIDS?","options": ["HPV","HIV","HBV","HCV"],"answer": 1},{"q": "HIV attacks specifically:","options": ["B-cells","Helper T-cells (CD4+)","Red blood cells","Platelets"],"answer": 1},{"q": "The mode of HIV transmission does NOT include:","options": ["Sexual contact","Blood transfusion","Sharing needles","Casual contact like hugging"],"answer": 3},{"q": "HIV can be transmitted from mother to child through:","options": ["Placenta","Breast milk","During delivery","All of these"],"answer": 3},{"q": "The enzyme that converts RNA to DNA in HIV is:","options": ["Reverse transcriptase","DNA polymerase","RNA polymerase","Ligase"],"answer": 0},{"q": "The shape of HIV is:","options": ["Helical","Icosahedral","Complex","Spherical with spikes"],"answer": 3},{"q": "Which is NOT a symptom of AIDS?","options": ["Persistent fever","Weight loss","Increased immunity","Opportunistic infections"],"answer": 2},{"q": "Opportunistic infections in AIDS patients are caused by:","options": ["Weakened immune system","Strong immune system","Genetic factors","Nutritional factors"],"answer": 0},{"q": "Kaposi's sarcoma in AIDS patients is a type of:","options": ["Bacterial infection","Viral infection","Fungal infection","Cancer"],"answer": 3},{"q": "Pneumocystis pneumonia in AIDS is caused by:","options": ["Bacteria","Virus","Fungus","Protozoan"],"answer": 2},{"q": "The window period in HIV infection refers to:","options": ["Time between infection and antibody detection","Time between infection and symptoms","Life span of virus","Incubation period"],"answer": 0},{"q": "ELISA test for HIV detects:","options": ["Virus particles","Antibodies against HIV","CD4 cells","Reverse transcriptase"],"answer": 1},{"q": "Western blot test is used to:","options": ["Confirm HIV infection","Treat AIDS","Prevent HIV","Isolate virus"],"answer": 0},{"q": "HAART stands for:","options": ["Highly Active Antiretroviral Therapy","HIV Active Antiretroviral Treatment","Human AIDS Antiretroviral Therapy","Highly Active AIDS Retroviral Treatment"],"answer": 0},{"q": "AZT (Zidovudine) is a:","options": ["Protease inhibitor","Reverse transcriptase inhibitor","Entry inhibitor","Integrase inhibitor"],"answer": 1},{"q": "Viruses are obligate intracellular parasites because they:","options": ["Can live outside host","Require host cell for reproduction","Are photosynthetic","Can reproduce on their own"],"answer": 1},{"q": "Bacteriophages have which shape?","options": ["Spherical","Helical","Complex with head and tail","Rod-shaped"],"answer": 2},{"q": "Lytic cycle of bacteriophage ends with:","options": ["Integration into host DNA","Lysis of host cell","Formation of prophage","Latent infection"],"answer": 1},{"q": "Lysogenic cycle involves:","options": ["Immediate host cell lysis","Integration of viral DNA into host genome","Production of virions immediately","No replication"],"answer": 1},{"q": "Prophage is:","options": ["Free virus particle","Integrated viral DNA in bacterial chromosome","Viral RNA","Viral protein"],"answer": 1},{"q": "Viruses that cause cancer are called:","options": ["Oncogenic viruses","Bacteriophages","Retroviruses","All viruses"],"answer": 0},{"q": "HPV (Human Papillomavirus) can cause:","options": ["Cervical cancer","Liver cancer","Lung cancer","Brain cancer"],"answer": 0},{"q": "Hepatitis B virus can cause:","options": ["Liver cancer","Lung cancer","Skin cancer","Blood cancer"],"answer": 0},{"q": "Influenza virus has:","options": ["DNA genome","RNA genome with segments","Single RNA strand","Double DNA strand"],"answer": 1},{"q": "The spikes on influenza virus contain:","options": ["Hemagglutinin (HA) and Neuraminidase (NA)","Reverse transcriptase","DNA polymerase","Capsid proteins"],"answer": 0},{"q": "Rabies virus has which shape?","options": ["Helical","Icosahedral","Bullet-shaped","Spherical"],"answer": 2},{"q": "Polio virus is a:","options": ["DNA virus","RNA virus","Retrovirus","Bacteriophage"],"answer": 1},{"q": "Smallpox virus is a:","options": ["DNA virus","RNA virus","Retrovirus","Prion"],"answer": 0},{"q": "Prions are:","options": ["Viruses","Infectious proteins","Bacteria","Fungi"],"answer": 1},{"q": "Mad cow disease is caused by:","options": ["Virus","Bacterium","Prion","Fungus"],"answer": 2},{"q": "Viroids are:","options": ["Infectious RNA without protein coat","Infectious DNA","Infectious proteins","Small bacteria"],"answer": 0},{"q": "Viroids cause diseases in:","options": ["Animals","Plants","Bacteria","Humans"],"answer": 1},{"q": "Which virus has double-stranded DNA?","options": ["HIV","Influenza","Herpes","Polio"],"answer": 2},{"q": "Retroviruses use which enzyme to make DNA from RNA?","options": ["DNA polymerase","RNA polymerase","Reverse transcriptase","Ligase"],"answer": 2},{"q": "Provirus is:","options": ["Viral RNA","Integrated viral DNA in eukaryotic cell","Free virus","Viral protein"],"answer": 1},{"q": "The latency period in HIV infection can last:","options": ["Few days","Few weeks","Months to years","Hours"],"answer": 2},{"q": "AIDS is diagnosed when CD4 count falls below:","options": ["500 cells/µL","200 cells/µL","1000 cells/µL","50 cells/µL"],"answer": 1},{"q": "Which is NOT an opportunistic infection in AIDS?","options": ["Tuberculosis","Candidiasis","Common cold","Toxoplasmosis"],"answer": 2},{"q": "HIV belongs to which family?","options": ["Herpesviridae","Retroviridae","Picornaviridae","Orthomyxoviridae"],"answer": 1},{"q": "HIV specifically binds to which receptor on host cell?","options": ["CD4 receptor","CD8 receptor","CD19 receptor","CD20 receptor"],"answer": 0},{"q": "Besides CD4, HIV also needs which co-receptor?","options": ["CCR5 or CXCR4","CD8","CD19","CD28"],"answer": 0},{"q": "Which cells besides T-helper cells can HIV infect?","options": ["Macrophages","Dendritic cells","Microglial cells","All of these"],"answer": 3},{"q": "The most common mode of HIV transmission worldwide is:","options": ["Sexual transmission","Blood transfusion","Needle sharing","Mother to child"],"answer": 0},{"q": "HIV is NOT transmitted through:","options": ["Sweat","Saliva","Tears","All of these"],"answer": 3},{"q": "The structure of HIV contains:","options": ["Two single-stranded RNA","One double-stranded DNA","Single-stranded DNA","Double-stranded RNA"],"answer": 0},{"q": "The outer envelope of HIV is derived from:","options": ["Host cell membrane","Viral proteins only","Bacterial membrane","Fungal cell wall"],"answer": 0},{"q": "GP120 and GP41 are:","options": ["HIV envelope glycoproteins","HIV enzymes","Host cell receptors","Antibodies"],"answer": 0},{"q": "Which enzyme integrates viral DNA into host genome?","options": ["Reverse transcriptase","Integrase","Protease","Ligase"],"answer": 1},{"q": "Protease enzyme in HIV is important for:","options": ["Cutting viral polyproteins","Converting RNA to DNA","Integration","Entry"],"answer": 0},{"q": "HIV replication occurs in:","options": ["Cytoplasm only","Nucleus only","Both cytoplasm and nucleus","Mitochondria"],"answer": 2},{"q": "During HIV infection, which antibodies are produced first?","options": ["IgG","IgM","IgA","IgE"],"answer": 1},{"q": "The asymptomatic stage of HIV infection is called:","options": ["Acute phase","Chronic phase","AIDS","Window period"],"answer": 1},{"q": "Acute HIV infection symptoms resemble:","options": ["Common cold or flu","Malaria","Tuberculosis","Diabetes"],"answer": 0},{"q": "Which body fluid has highest concentration of HIV?","options": ["Blood","Semen","Vaginal fluid","Breast milk"],"answer": 0},{"q": "Pre-exposure prophylaxis (PrEP) is:","options": ["Treatment after infection","Prevention before exposure","Vaccine","Diagnostic test"],"answer": 1},{"q": "PEP (Post-exposure prophylaxis) should be started within:","options": ["24-72 hours after exposure","1 week","1 month","6 hours"],"answer": 0},{"q": "Mother-to-child transmission of HIV can be reduced by:","options": ["Antiretroviral drugs during pregnancy","Cesarean delivery","Avoiding breastfeeding","All of these"],"answer": 3},{"q": "Which is NOT a class of antiretroviral drugs?","options": ["Nucleoside reverse transcriptase inhibitors","Protease inhibitors","Integrase inhibitors","Penicillins"],"answer": 3},{"q": "Vaccine for HIV is:","options": ["Available and effective","Not yet available","Only for animals","Only for certain strains"],"answer": 1},{"q": "Which test measures viral load in HIV patients?","options": ["ELISA","Western blot","PCR","CD4 count"],"answer": 2},{"q": "CD4 count in healthy individual is about:","options": ["200-500 cells/µL","500-1500 cells/µL","50-200 cells/µL","2000-3000 cells/µL"],"answer": 1},{"q": "HIV can be inactivated by:","options": ["Heat","Bleach","Alcohol","All of these"],"answer": 3},{"q": "Which virus causes chickenpox?","options": ["Varicella-zoster virus","HIV","HPV","HBV"],"answer": 0},{"q": "Which virus is transmitted by mosquito?","options": ["Dengue virus","HIV","Hepatitis B","Influenza"],"answer": 0},{"q": "Arboviruses are transmitted by:","options": ["Arthropods","Air","Water","Food"],"answer": 0},{"q": "Rotavirus causes:","options": ["Diarrhea in children","Respiratory infection","Liver disease","Neurological disease"],"answer": 0},{"q": "Norovirus causes:","options": ["Gastroenteritis","AIDS","Hepatitis","Influenza"],"answer": 0},{"q": "Rhinovirus causes:","options": ["Common cold","AIDS","Hepatitis","Rabies"],"answer": 0},{"q": "Coronaviruses can cause:","options": ["Common cold","SARS","MERS","All of these"],"answer": 3},{"q": "Ebola virus causes:","options": ["Hemorrhagic fever","Respiratory illness","Liver disease","Neurological disease"],"answer": 0},{"q": "Zika virus is transmitted by:","options": ["Mosquito","Sexual contact","Mother to fetus","All of these"],"answer": 3},{"q": "Viruses are measured in:","options": ["Micrometers","Nanometers","Millimeters","Centimeters"],"answer": 1},{"q": "The largest viruses are comparable in size to:","options": ["Bacteria","Red blood cells","Atoms","Molecules"],"answer": 0},{"q": "Mimivirus is notable for its:","options": ["Small size","Large size and genome","Lack of DNA","Plant infection"],"answer": 1},{"q": "Bacteriophages were discovered by:","options": ["Alexander Fleming","Frederick Twort and Felix d'Herelle","Louis Pasteur","Robert Koch"],"answer": 1},{"q": "TMV was discovered by:","options": ["Dimitri Ivanovsky","Louis Pasteur","Robert Koch","Edward Jenner"],"answer": 0},{"q": "The first human virus discovered was:","options": ["Yellow fever virus","HIV","Influenza virus","Polio virus"],"answer": 0},{"q": "Viruses can be cultured in:","options": ["Artificial media","Living cells only","Both","None"],"answer": 1},{"q": "Plaque assay is used to:","options": ["Count viruses","Count bacteria","Measure pH","Detect antibodies"],"answer": 0},{"q": "Viruses that cause tumors are called:","options": ["Oncogenic viruses","Cytopathic viruses","Latent viruses","Lytic viruses"],"answer": 0},{"q": "Latent viral infection means:","options": ["Virus replicates continuously","Virus remains dormant","Immediate symptoms","Rapid lysis"],"answer": 1},{"q": "Herpes virus can remain:","options": ["Latent in nerve cells","Active always","Only in blood","In digestive system"],"answer": 0},{"q": "Cold sores are caused by:","options": ["Herpes simplex virus","HIV","Influenza","Rhinovirus"],"answer": 0},{"q": "Shingles is caused by reactivation of:","options": ["Varicella-zoster virus","HIV","HPV","HBV"],"answer": 0},{"q": "Viruses can be prevented by:","options": ["Antibiotics","Vaccines","Both","Neither"],"answer": 1},{"q": "Antibiotics are ineffective against viruses because viruses:","options": ["Have cell walls","Lack metabolic pathways targeted by antibiotics","Are too small","Are living"],"answer": 1},{"q": "Interferons are produced by host cells in response to:","options": ["Bacterial infection","Viral infection","Fungal infection","All"],"answer": 1},{"q": "Viruses can be visualized using:","options": ["Light microscope","Electron microscope","Naked eye","Telescope"],"answer": 1},{"q": "The capsid is made of protein subunits called:","options": ["Capsomeres","Envelopes","Spikes","Nucleoids"],"answer": 0},{"q": "Icosahedral capsid has how many faces?","options": ["10","20","30","40"],"answer": 1},{"q": "Helical capsid is found in:","options": ["TMV","HIV","Adenovirus","Polio virus"],"answer": 0},{"q": "Complex capsid is found in:","options": ["Bacteriophages","HIV","Influenza","Herpes"],"answer": 0},{"q": "Viral envelopes are acquired from:","options": ["Host cell membranes","Viral synthesis","Environment","Other viruses"],"answer": 0},{"q": "Enveloped viruses are generally more susceptible to:","options": ["Detergents","Heat","Drying","All"],"answer": 3},{"q": "Naked viruses are more resistant to:","options": ["Environmental conditions","Antibiotics","Antibodies","All"],"answer": 0},{"q": "Viruses that infect plants often enter through:","options": ["Wounds","Stomata","Roots","All"],"answer": 0},{"q": "Plant viruses are often transmitted by:","options": ["Insects","Nematodes","Fungi","All"],"answer": 3},{"q": "Viruses can be used in biotechnology for:","options": ["Gene therapy","Vaccine production","As vectors","All"],"answer": 3},{"q": "The study of viruses is called:","options": ["Bacteriology","Virology","Mycology","Parasitology"],"answer": 1},{"q": "Which statement about viruses is correct?","options": ["They have both DNA and RNA","They can reproduce independently","They are acellular","They have ribosomes"],"answer": 2}]}];

    let activeTestMCQs = [], userSelections = [], currentOpenTest = null, timerInterval = null, totalSeconds = 0, currentStep = 0, pendingTestId = null;

    /* --- 3. FILTER & NAVIGATION LOGIC --- */
    function initializeFilters() { updateExams(); }

    function updateExams() {
        const examSelect = document.getElementById('filter-exam');
        examSelect.innerHTML = '<option value="all">All Exams</option>';
        mdcatExams.forEach(e => { examSelect.innerHTML += `<option value="${e}">${e}</option>`; });
        updateSubjects();
    }

    function updateSubjects() {
        const exam = document.getElementById('filter-exam').value;
        const subSelect = document.getElementById('filter-subject');
        subSelect.innerHTML = '<option value="all">All Subjects</option>';
        if (exam !== 'all') {
            (examSubjects[exam] || []).forEach(s => { subSelect.innerHTML += `<option value="${s}">${s}</option>`; });
        }
        loadTests();
    }

    function updateChapters() { loadTests(); }

    function loadTests() {
        const container = document.getElementById('tests-container');
        const prov = document.getElementById('filter-province').value;
        const exam = document.getElementById('filter-exam').value;
        
        const filtered = testsData.filter(t => (prov === 'all' || t.province === prov) && (exam === 'all' || t.exam === exam));
        
        container.innerHTML = filtered.map(test => `
            <div class="card">
                <div>
                    <h4>${test.title}</h4>
                    <div class="card-meta">
                        <span><i class="fas fa-list-ol"></i> ${test.mcqs.length} MCQs</span>
                        <span><i class="fas fa-graduation-cap"></i> ${test.exam}</span>
                        <span><i class="fas fa-map-marker-alt"></i> ${test.province}</span>
                    </div>
                </div>
                <button class="primary-button" onclick="openConfigModal('${test.id}')"><i class="fas fa-play"></i> Start Test</button>
            </div>
        `).join('');
    }

    /* --- 4. STEP-BY-STEP QUIZ LOGIC --- */
    function openConfigModal(id) { pendingTestId = id; document.getElementById('configModal').style.display = 'block'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; clearInterval(timerInterval); }

    function handleDetailsSubmit(e) {
        e.preventDefault();
        document.getElementById('configModal').style.display = 'none';
        startActualQuiz(pendingTestId);
    }

    function startActualQuiz(id) {
        const test = testsData.find(t => t.id === id);
        currentOpenTest = test;
        activeTestMCQs = [...test.mcqs];
        userSelections = new Array(activeTestMCQs.length).fill(-1);
        currentStep = 0;
        
        renderQuizStep();
        document.getElementById('testModal').style.display = 'block';
        startTimer(activeTestMCQs.length * 40); // 40 Seconds per MCQ logic
    }

    function renderQuizStep() {
        const m = activeTestMCQs[currentStep];
        const container = document.getElementById('mcq-steps-container');
        
        container.innerHTML = `
            <div class="mcq-step active">
                <p style="color:var(--color-primary-blue); font-weight:700;">Question ${currentStep + 1} of ${activeTestMCQs.length}</p>
                <p style="font-weight:600; font-size:1.1rem; margin-top:10px;">${m.q}</p>
                <div style="margin-top:20px;">
                    ${m.options.map((opt, oi) => `
                        <label style="display:block; padding:15px; border:2px solid #eee; border-radius:10px; cursor:pointer; margin-bottom:10px;" id="label-${currentStep}-${oi}">
                            <input type="radio" name="q${currentStep}" value="${oi}" ${userSelections[currentStep] === oi ? 'checked' : ''} onchange="userSelections[${currentStep}]=${oi}"> ${opt}
                        </label>
                    `).join('')}
                </div>
                <div class="quiz-footer">
                    <button type="button" class="secondary-button" style="width:120px; visibility:${currentStep === 0 ? 'hidden' : 'visible'}" onclick="moveStep(-1)">Previous</button>
                    ${currentStep === activeTestMCQs.length - 1 
                        ? `<button type="button" class="primary-button" style="width:150px; background:var(--color-danger);" onclick="submitTest()">Submit Test</button>`
                        : `<button type="button" class="primary-button" style="width:120px;" onclick="moveStep(1)">Next</button>`}
                </div>
            </div>
        `;
    }

    function moveStep(n) { currentStep += n; renderQuizStep(); }

    function startTimer(sec) {
        totalSeconds = sec;
        timerInterval = setInterval(() => {
            const m = Math.floor(totalSeconds / 60), s = totalSeconds % 60;
            document.getElementById('time-left').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            if(--totalSeconds < 0) { clearInterval(timerInterval); submitTest(); }
        }, 1000);
    }

    function submitTest() {
        clearInterval(timerInterval);
        let correct = 0;
        activeTestMCQs.forEach((m, i) => { if(userSelections[i] === m.answer) correct++; });
        
        document.getElementById('final-score').innerText = Math.round((correct/activeTestMCQs.length)*100) + "%";
        document.getElementById('final-correct').innerText = correct;
        document.getElementById('final-total').innerText = activeTestMCQs.length;
        
        document.getElementById('testModal').style.display = 'none';
        document.getElementById('resultPopup').style.display = 'block';
    }

    function checkTest() {
        document.getElementById('testModal').style.display = 'block';
        currentStep = 0;
        renderReview();
    }

    function renderReview() {
        const m = activeTestMCQs[currentStep];
        const sel = userSelections[currentStep];
        document.getElementById('mcq-steps-container').innerHTML = `
            <div class="mcq-step active">
                <p style="font-weight:600; font-size:1.1rem;">${m.q}</p>
                <div style="margin-top:20px;">
                    ${m.options.map((opt, oi) => {
                        let cls = "";
                        if(oi === m.answer) cls = "correct-ans";
                        else if(oi === sel) cls = "wrong-ans";
                        return `<label class="${cls}" style="display:block; padding:15px; border:2px solid #eee; border-radius:10px; margin-bottom:10px;">${opt}</label>`;
                    }).join('')}
                </div>
                <div class="quiz-footer">
                    <button type="button" class="secondary-button" style="width:120px; visibility:${currentStep === 0 ? 'hidden' : 'visible'}" onclick="revNav(-1)">Prev</button>
                    <button type="button" class="primary-button" style="width:120px; visibility:${currentStep === activeTestMCQs.length-1 ? 'hidden' : 'visible'}" onclick="revNav(1)">Next</button>
                </div>
            </div>
        `;
    }
    function revNav(n) { currentStep += n; renderReview(); }

    /* --- 5. PDF DOWNLOAD LOGIC (PRESERVED BRANDING) --- */
    function downloadTestPDF() {
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        const stdName = document.getElementById('user-name').value || "Student";
        const score = document.getElementById('final-score').innerText;
        doc.setFillColor(0, 123, 255); doc.rect(0, 0, 210, 45, 'F');
        doc.setTextColor(255, 255, 255); doc.setFontSize(24); doc.setFont("helvetica", "bold");
        doc.text("DANI MEDICO", 14, 25);
        doc.setFontSize(10); doc.setFont("helvetica", "normal");
        doc.text("Quality Medical Preparation Result Card", 14, 33);
        doc.setTextColor(0,0,0); doc.text(`Name: ${stdName}`, 14, 60); doc.text(`Score: ${score}`, 14, 70);
        doc.save(`DaniMedico_${stdName}.pdf`);
    }

    document.addEventListener('DOMContentLoaded', initializeFilters);
    function mobileMenuToggle() { document.getElementById('navLinks').classList.toggle('active'); }
</script>
</body>
</html>
